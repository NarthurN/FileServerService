# Техническая спецификация: Кеширующий веб-сервер для управления документами

## 1. Введение

### Цель проекта
Разработка HTTP-сервера на Go для управления электронными документами с возможностью аутентификации, авторизации и кеширования. Система должна обеспечивать высокую производительность при значительной нагрузке на операции чтения.

### Основные функции
- Регистрация и аутентификация пользователей
- Загрузка, получение и удаление документов
- Управление доступом к документам
- Кеширование для повышения производительности
- REST API для взаимодействия с клиентами

### Уровни сложности
1. **Первый уровень**: Получение списка документов и одного документа
2. **Второй уровень**: + Загрузка и удаление документов
3. **Третий уровень**: + Регистрация и аутентификация
4. **Четвертый уровень**: + Полноценное кеширование

## 2. Архитектура системы

### 2.1 Высокоуровневая архитектура

```
┌─────────────────┐       ┌─────────────────┐       ┌─────────────────┐
│   HTTP Client   │◄─────►│   HTTP Server   │◄─────►│   File System   │
│  (Web/Mobile)   │       │   (Go Service)  │       │   (Documents)   │
└─────────────────┘       └─────────────────┘       └─────────────────┘
                                    │                          │
                                    ▼                          ▼
                          ┌─────────────────┐       ┌─────────────────┐
                          │   Cache Layer   │       │    Database     │
                          │   (In-Memory)   │       │ (PostgreSQL/    │
                          └─────────────────┘       │  SQLite)        │
                                                    └─────────────────┘
```

### 2.2 Компоненты системы

```
┌─────────────────────────────────────────────────────────────────────┐
│                          HTTP Server (Go)                           │
├─────────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐ │
│  │   Auth      │  │   Docs      │  │   Cache     │  │   Config    │ │
│  │  Handler    │  │  Handler    │  │  Manager    │  │  Manager    │ │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘ │
├─────────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐ │
│  │   User      │  │  Document   │  │   Token     │  │   Access    │ │
│  │  Service    │  │  Service    │  │  Service    │  │  Service    │ │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘ │
├─────────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐ │
│  │  Database   │  │    Cache    │  │    File     │  │   Logger    │ │
│  │  Repository │  │  Repository │  │  Repository │  │             │ │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘ │
└─────────────────────────────────────────────────────────────────────┘
```

### 2.3 Диаграмма последовательности - Аутентификация

```
Client          Server         Database       Cache
  │               │               │             │
  │──POST /auth──►│               │             │
  │               │──validate────►│             │
  │               │◄─user info────│             │
  │               │──gen token────│             │
  │               │──store token─►│             │
  │               │──cache token─────────────►│
  │◄─auth resp────│               │             │
```

### 2.4 Диаграмма последовательности - Получение документа

```
Client          Server         Cache         Database      FileSystem
  │               │             │               │             │
  │──GET /docs/id─►│             │               │             │
  │               │──check cache───────────────►│             │
  │               │◄─cache hit──────────────────│             │
  │               │ (if miss)   │               │             │
  │               │──get doc────────────────────►│             │
  │               │◄─doc info───────────────────│             │
  │               │──read file──────────────────────────────►│
  │               │◄─file data──────────────────────────────│
  │               │──update cache───────────────►│             │
  │◄─document─────│             │               │             │
```

## 3. Структура базы данных

### 3.1 Схема базы данных

```sql
-- Пользователи
CREATE TABLE users (
    id UUID PRIMARY KEY,
    login VARCHAR(255) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Токены авторизации
CREATE TABLE auth_tokens (
    token VARCHAR(255) PRIMARY KEY,
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    expires_at TIMESTAMP NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Документы
CREATE TABLE documents (
    id UUID PRIMARY KEY,
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    name VARCHAR(255) NOT NULL,
    mime_type VARCHAR(255),
    file_path VARCHAR(500),
    is_file BOOLEAN DEFAULT true,
    is_public BOOLEAN DEFAULT false,
    json_data JSONB,
    grants JSONB DEFAULT '[]'::jsonb,  -- Массив логинов с доступом
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Права доступа к документам
CREATE TABLE document_grants (
    id UUID PRIMARY KEY,
    document_id UUID REFERENCES documents(id) ON DELETE CASCADE,
    user_login VARCHAR(255) NOT NULL,
    granted_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### 3.2 Индексы для производительности

```sql
-- Индексы для быстрого поиска
CREATE INDEX idx_users_login ON users(login);
CREATE INDEX idx_auth_tokens_user_id ON auth_tokens(user_id);
CREATE INDEX idx_documents_user_id ON documents(user_id);
CREATE INDEX idx_documents_created_at ON documents(created_at);
CREATE INDEX idx_documents_name ON documents(name);
CREATE INDEX idx_document_grants_document_id ON document_grants(document_id);
```

## 4. REST API спецификация

### 4.1 Общая структура ответа

```json
{
  "error": {
    "code": 123,
    "text": "Error description"
  },
  "response": {
    "status": "success"
  },
  "data": {
    "content": "..."
  }
}
```

### 4.2 Коды ошибок

| HTTP Status | Описание |
|-------------|----------|
| 200 | Успешный запрос |
| 400 | Некорректные параметры |
| 401 | Не авторизован |
| 403 | Нет прав доступа |
| 405 | Неверный метод запроса |
| 500 | Внутренняя ошибка сервера |
| 501 | Метод не реализован |

### 4.3 Эндпоинты

#### POST /api/register
```json
// Запрос
{
  "token": "admin_token",
  "login": "username123",
  "pswd": "Password1@"
}

// Ответ
{
  "response": {
    "login": "username123"
  }
}
```

#### POST /api/auth
```json
// Запрос
{
  "login": "username123",
  "pswd": "Password1@"
}

// Ответ
{
  "response": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
  }
}
```

#### GET /api/docs
```json
// Ответ
{
  "data": {
    "docs": [
      {
        "id": "uuid-string",
        "name": "document.pdf",
        "mime": "application/pdf",
        "file": true,
        "public": false,
        "created": "2024-01-15 10:30:00",
        "grant": ["user1", "user2"]
      }
    ]
  }
}
```

## 5. Система кеширования

### 5.1 Архитектура кеша

```
┌─────────────────┐
│  HTTP Handler   │
└─────────────────┘
         │
         ▼
┌─────────────────┐     ┌─────────────────┐
│  Cache Manager  │────►│   LRU Cache     │
└─────────────────┘     │  (In-Memory)    │
         │               └─────────────────┘
         ▼
┌─────────────────┐
│   Data Source   │
│  (DB + Files)   │
└─────────────────┘
```

### 5.2 Стратегия кеширования

**Что кешируется:**
- Метаданные документов (GET /api/docs)
- Содержимое файлов (GET /api/docs/{id})
- Информация о пользователях
- Результаты авторизации

**Инвалидация кеша:**
- POST /api/docs → инвалидация списка документов
- DELETE /api/docs/{id} → инвалидация конкретного документа и списка
- Обновление прав доступа → инвалидация связанных записей

### 5.3 Ключи кеша

```
// Списки документов
"docs:list:user:{user_id}:filter:{hash}"

// Отдельные документы
"docs:item:{doc_id}"

// Права доступа
"docs:access:{doc_id}:{user_id}"

// Пользователи
"user:{user_id}"
```

## 6. План реализации

### 6.1 Этапы разработки

| Этап | Описание | Сроки | Сложность |
|------|----------|-------|-----------|
| **MVP** | Базовая структура + чтение документов | 3-4 дня | Низкая |
| **Release 1** | + Загрузка и удаление документов | 2-3 дня | Средняя |
| **Release 2** | + Аутентификация и авторизация | 3-4 дня | Высокая |
| **Release 3** | + Полноценное кеширование | 2-3 дня | Средняя |

### 6.2 Детализация задач

#### MVP (Уровень 1)
- [ ] Настройка проекта и зависимостей
- [ ] Создание структуры базы данных
- [ ] Реализация моделей данных
- [ ] Базовый HTTP-сервер
- [ ] GET /api/docs - получение списка документов
- [ ] GET /api/docs/{id} - получение документа
- [ ] HEAD поддержка для всех эндпоинтов
- [ ] Базовые тесты

**Ресурсы:** 1 разработчик, 3-4 дня
**Результат:** Рабочий сервер с операциями чтения

#### Release 1 (Уровень 2)
- [ ] POST /api/docs - загрузка документов
- [ ] DELETE /api/docs/{id} - удаление документов
- [ ] Обработка multipart/form-data
- [ ] Работа с файловой системой
- [ ] Валидация входных данных
- [ ] Расширенные тесты

**Ресурсы:** 1 разработчик, 2-3 дня
**Результат:** Полноценный CRUD для документов

#### Release 2 (Уровень 3)
- [ ] POST /api/register - регистрация пользователей
- [ ] POST /api/auth - аутентификация
- [ ] DELETE /api/auth/{token} - завершение сессии
- [ ] Система токенов авторизации
- [ ] Middleware для проверки авторизации
- [ ] Управление правами доступа
- [ ] Хеширование паролей
- [ ] Тесты безопасности

**Ресурсы:** 1 разработчик, 3-4 дня
**Результат:** Полная система аутентификации

#### Release 3 (Уровень 4)
- [ ] Реализация кеш-менеджера
- [ ] LRU кеш для данных
- [ ] Стратегии инвалидации
- [ ] Метрики кеширования
- [ ] Оптимизация производительности
- [ ] Нагрузочное тестирование

**Ресурсы:** 1 разработчик, 2-3 дня
**Результат:** Высокопроизводительная система с кешированием

### 6.3 Технические детали

#### Стек технологий
- **Язык:** Go 1.19+
- **База данных:** PostgreSQL (или SQLite для разработки)
- **HTTP Router:** gorilla/mux или gin-gonic
- **Миграции:** golang-migrate
- **Кеширование:** sync.Map или third-party решение
- **Тестирование:** testify

#### Структура проекта
```
document-server/
├── cmd/
│   └── server/
│       └── main.go
├── internal/
│   ├── config/
│   ├── handlers/
│   ├── models/
│   ├── services/
│   ├── repository/
│   └── middleware/
├── pkg/
│   ├── cache/
│   ├── auth/
│   └── validation/
├── migrations/
├── tests/
└── docs/
```

#### Рекомендуемые библиотеки
- `github.com/gorilla/mux` - HTTP роутинг
- `github.com/lib/pq` - PostgreSQL драйвер
- `github.com/jmoiron/sqlx` - расширенный SQL
- `github.com/satori/go.uuid` - генерация UUID
- `golang.org/x/crypto/bcrypt` - хеширование паролей
- `github.com/golang-jwt/jwt/v4` - JWT токены
- `github.com/stretchr/testify` - тестирование

## 7. Безопасность

### 7.1 Аутентификация и авторизация
- Хеширование паролей с использованием bcrypt
- JWT токены с истечением срока действия
- Проверка прав доступа на уровне документов
- Валидация входных данных

### 7.2 Защита от атак
- Rate limiting для API эндпоинтов
- Валидация MIME типов файлов
- Ограничение размера загружаемых файлов
- Защита от path traversal атак

### 7.3 Конфигурация безопасности
```yaml
security:
  admin_token: "secure_admin_token_here"
  jwt_secret: "your_jwt_secret_key"
  password_salt_rounds: 12
  token_expiry_hours: 24
  max_file_size_mb: 100
```

## 8. Мониторинг и логирование

### 8.1 Метрики производительности
- Время ответа API
- Коэффициент попаданий в кеш
- Количество активных пользователей
- Использование памяти и CPU

### 8.2 Логирование
- Структурированные логи (JSON)
- Логирование всех API запросов
- Логирование ошибок с stack trace
- Ротация логов

## 9. Тестирование

### 9.1 Стратегия тестирования
- **Unit тесты:** Покрытие всех сервисов и репозиториев
- **Integration тесты:** Тестирование HTTP эндпоинтов
- **Load тесты:** Проверка производительности под нагрузкой
- **Security тесты:** Проверка уязвимостей

### 9.2 Тестовая среда
```go
// Пример unit теста
func TestDocumentService_GetDocument(t *testing.T) {
    // Arrange
    mockRepo := &MockDocumentRepository{}
    service := NewDocumentService(mockRepo)

    // Act
    doc, err := service.GetDocument("test-id", "user-id")

    // Assert
    assert.NoError(t, err)
    assert.NotNil(t, doc)
}
```

## 10. Риски и контрольные точки

### 10.1 Технические риски

| Риск | Вероятность | Воздействие | Митигация |
|------|-------------|-------------|-----------|
| Проблемы с производительностью кеша | Средняя | Высокое | Нагрузочное тестирование, профилирование |
| Сложность с правами доступа | Средняя | Среднее | Детальное проектирование, тесты |
| Уязвимости безопасности | Низкая | Высокое | Code review, security тесты |

### 10.2 Контрольные точки

**После MVP:**
- [ ] Функциональность чтения документов работает
- [ ] Базовая архитектура протестирована
- [ ] Производительность соответствует требованиям

**После Release 1:**
- [ ] CRUD операции полностью реализованы
- [ ] Файловая система работает корректно
- [ ] Тесты покрывают основной функционал

**После Release 2:**
- [ ] Аутентификация работает надежно
- [ ] Права доступа корректно проверяются
- [ ] Безопасность протестирована

**После Release 3:**
- [ ] Кеширование значительно улучшает производительность
- [ ] Система готова к производственной нагрузке
- [ ] Все требования технического задания выполнены

## 11. Заключение

Данная техническая спецификация описывает полную реализацию кеширующего веб-сервера для управления документами. Поэтапный подход позволяет получить работающую систему уже на раннем этапе разработки и постепенно добавлять функциональность.

Ключевые преимущества архитектуры:
- Модульность и расширяемость
- Высокая производительность за счет кеширования
- Надежная система безопасности
- Готовность к масштабированию

Общий срок реализации: **10-14 дней** для одного разработчика.
